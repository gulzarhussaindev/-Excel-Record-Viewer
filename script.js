let workbook,sheetData=[],headers=[],currentIndex=0,matches=[],matchIndex=0,visibleHeaders=JSON.parse(localStorage.getItem("visibleHeaders")||"null")||[];const fileInput=document.getElementById("fileInput"),sheetSelector=document.getElementById("sheetSelector"),sheetSelectorContainer=document.getElementById("sheetSelectorContainer"),prevBtn=document.getElementById("prevBtn"),nextBtn=document.getElementById("nextBtn"),goBtn=document.getElementById("goBtn"),filterBtn=document.getElementById("filterBtn"),searchIndexInput=document.getElementById("searchIndex"),filterColumnSelect=document.getElementById("filterColumn"),filterValueInput=document.getElementById("filterValue"),recordViewer=document.getElementById("recordViewer"),tableViewContainer=document.getElementById("tableViewContainer"),filterInfoDiv=document.getElementById("filterInfo"),matchInfoDiv=document.getElementById("matchInfo"),selectFieldsBtn=document.getElementById("selectFieldsBtn"),headerModal=document.getElementById("headerModal"),headerOptions=document.getElementById("headerOptions"),selectAllBtn=document.getElementById("selectAllBtn"),unselectAllBtn=document.getElementById("unselectAllBtn"),closeModalBtn=document.getElementById("closeModalBtn"),toggleTableBtn=document.getElementById("toggleTableBtn"),exportBtn=document.getElementById("exportBtn"),installBtn=document.getElementById("installBtn");document.body.hasAttribute("tabindex")||document.body.setAttribute("tabindex","-1");let viewMode=localStorage.getItem("viewMode")||"form";disableUI(!0),fileInput.addEventListener("change",handleFile),prevBtn.addEventListener("click",(()=>navigateRelative(-1))),nextBtn.addEventListener("click",(()=>navigateRelative(1))),goBtn.addEventListener("click",goToRecord),filterBtn.addEventListener("click",filterRecords),sheetSelector.addEventListener("change",(()=>loadSheet(sheetSelector.value))),searchIndexInput.addEventListener("keydown",(e=>{"Enter"===e.key&&goToRecord()})),filterValueInput.addEventListener("keydown",(e=>{"Enter"===e.key&&filterRecords()})),selectFieldsBtn.addEventListener("click",openHeaderModal),closeModalBtn.addEventListener("click",(()=>{headerModal.style.display="none",headerModal.setAttribute("aria-hidden","true")})),selectAllBtn.addEventListener("click",(()=>{visibleHeaders=[...headers],saveVisibleHeaders(),renderHeaderOptions(),showCurrentView()})),unselectAllBtn.addEventListener("click",(()=>{visibleHeaders=[],saveVisibleHeaders(),renderHeaderOptions(),showCurrentView()})),window.addEventListener("click",(e=>{e.target===headerModal&&(headerModal.style.display="none",headerModal.setAttribute("aria-hidden","true"))})),toggleTableBtn.addEventListener("click",(()=>{viewMode="form"===viewMode?"table":"form",localStorage.setItem("viewMode",viewMode),updateViewButtons(),showCurrentView()})),exportBtn.addEventListener("click",(()=>{showExportMenu()}));let deferredPrompt=null;function saveVisibleHeaders(){try{localStorage.setItem("visibleHeaders",JSON.stringify(visibleHeaders))}catch(e){}}function loadVisibleHeaders(){try{const e=JSON.parse(localStorage.getItem("visibleHeaders"));return Array.isArray(e)?e:null}catch(e){return null}}function handleFile(e){const t=e.target.files?.[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const t=new Uint8Array(e.target.result);workbook=XLSX.read(t,{type:"array"})}catch(e){return void showEmptyMessage("Unable to read file.")}if(workbook.SheetNames&&0!==workbook.SheetNames.length){sheetSelector.innerHTML="",workbook.SheetNames.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,sheetSelector.appendChild(t)})),sheetSelectorContainer.style.display=workbook.SheetNames.length>1?"block":"none",loadSheet(workbook.SheetNames[0]),disableUI(!1);try{document.body.focus()}catch(e){}syncUI()}else showEmptyMessage("No sheets found in file.")},n.readAsArrayBuffer(t)}function loadSheet(e){const t=workbook.Sheets[e],n=XLSX.utils.sheet_to_json(t,{header:1,raw:!1,cellDates:!0,dateNF:"dd-mm-yyyy"});if(!Array.isArray(n)||0===n.length||Array.isArray(n[0])&&0===n[0].length)return headers=[],sheetData=[],showEmptyMessage("No data in this sheet."),disableUI(!0),void syncUI();const{headerRowIndex:a,headers:o}=detectHeaderRow(n);headers=o.length?o:n[0].map((e=>null==e?"":String(e))),sheetData=n.slice(a+1).map((e=>(Array.isArray(e)?e:[]).map((e=>{if(e instanceof Date){const t=e;return`${String(t.getDate()).padStart(2,"0")}-${String(t.getMonth()+1).padStart(2,"0")}-${t.getFullYear()}`}if("number"==typeof e&&e>2e4&&e<6e4){const t=new Date(1899,11,30),n=new Date(t.getTime()+864e5*Math.floor(e));return`${String(n.getDate()).padStart(2,"0")}-${String(n.getMonth()+1).padStart(2,"0")}-${n.getFullYear()}`}if("string"==typeof e&&/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(e.trim())){const[t,n,a]=e.split("/");return`${String(t).padStart(2,"0")}-${String(n).padStart(2,"0")}-${2===a.length?"20"+a:a}`}return e??""})))),currentIndex=0,matches=[],matchIndex=0;const r=loadVisibleHeaders();r&&Array.isArray(r)?(visibleHeaders=r.filter((e=>headers.includes(e))),0===visibleHeaders.length&&(visibleHeaders=headers.slice())):visibleHeaders=headers.slice(),populateFilterDropdown(),renderHeaderOptions(),updateViewButtons(),showCurrentView(),syncUI()}function detectHeaderRow(e,t=10){const n=Math.min(e.length,t);let a=-1,o=0;for(let t=0;t<n;t++){const n=e[t];if(!n)continue;let r=0,l=0;n.forEach(((e,t)=>{null!=e&&""!==String(e).trim()&&(l++,isNaN(e)&&(r+=1),String(e).length<150&&(r+=.5))}));const s=e[t+1]||[];let d=0;s.forEach((e=>{isNaN(e)||""===e||d++})),d>=n.length/2&&(r+=1),l<n.length/2&&(r-=1),r>a&&(a=r,o=t)}return{headerRowIndex:o,headers:e[o].map((e=>null!=e?String(e):""))}}function disableUI(e){[prevBtn,nextBtn,goBtn,filterBtn,searchIndexInput,filterColumnSelect,filterValueInput].forEach((t=>t.disabled=e)),toggleTableBtn.style.display=e?"none":"inline-block",exportBtn.style.display=e?"none":"inline-block"}function showEmptyMessage(e){recordViewer.style.display="block",tableViewContainer.style.display="none",recordViewer.className="card",recordViewer.innerHTML="";const t=document.createElement("div");t.className="no-record",t.textContent=e,recordViewer.appendChild(t),matchInfoDiv.style.display="none",filterInfoDiv.style.display="none"}function populateFilterDropdown(){filterColumnSelect.innerHTML="",headers.forEach(((e,t)=>{const n=document.createElement("option");n.value=t,n.textContent=e||`Column ${t+1}`,filterColumnSelect.appendChild(n)}))}function openHeaderModal(){renderHeaderOptions(),headerModal.style.display="flex",headerModal.setAttribute("aria-hidden","false")}function renderHeaderOptions(){headerOptions.innerHTML="",headers&&headers.length?headers.forEach((e=>{const t=document.createElement("div");t.className="header-card";const n=document.createElement("input");n.type="checkbox",n.value=e,n.checked=visibleHeaders.includes(e),n.style.marginRight="8px";const a=document.createElement("span");a.textContent=e,t.appendChild(n),t.appendChild(a),t.addEventListener("click",(t=>{"INPUT"!==t.target.tagName&&(n.checked=!n.checked),n.checked?visibleHeaders.includes(e)||visibleHeaders.push(e):visibleHeaders=visibleHeaders.filter((t=>t!==e)),saveVisibleHeaders(),showCurrentView()})),headerOptions.appendChild(t)})):headerOptions.textContent="No headers found."}function showRecord(e){if(!sheetData||0===sheetData.length)return void showEmptyMessage("0 records.");e<0&&(e=0),e>=sheetData.length&&(e=sheetData.length-1),currentIndex=e,viewMode="form",localStorage.setItem("viewMode",viewMode),updateViewButtons(),tableViewContainer.style.display="none",recordViewer.className="card form-view",recordViewer.innerHTML="";const t=document.createElement("div");t.style.gridColumn="1 / -1",t.style.marginBottom="6px",t.style.fontWeight="600",t.textContent=`Record ${currentIndex+1} of ${sheetData.length}`,recordViewer.appendChild(t);const n=sheetData[currentIndex];(visibleHeaders&&visibleHeaders.length?visibleHeaders:headers).forEach((e=>{const t=headers.indexOf(e);if(-1===t)return;const a=null!=n[t]?String(n[t]):"",o=document.createElement("div");o.className="field";const r=document.createElement("span");r.className="label",r.textContent=e+":";const l=document.createElement("span");l.className="field-value";const s=document.createElement("span");s.className="full-text",s.style.display="none",s.textContent=a;if(a.length>80){l.textContent=a.slice(0,80)+"...";const e=document.createElement("button");e.className="expand-btn",e.type="button",e.textContent="Expand",o.append(r,l,e,s)}else l.textContent=a,o.append(r,l);recordViewer.appendChild(o)})),updateNavButtons(),updateMatchInfo(),syncUI()}function renderTableView(){if(tableViewContainer.innerHTML="",tableViewContainer.style.display="block",recordViewer.style.display="none",!sheetData||0===sheetData.length){const e=document.createElement("div");return e.className="no-record",e.textContent="No records to show.",void tableViewContainer.appendChild(e)}const e=visibleHeaders&&visibleHeaders.length?visibleHeaders:headers,t=document.createElement("table");t.className="table";const n=document.createElement("thead"),a=document.createElement("tr");e.forEach((e=>{const t=document.createElement("th");t.textContent=e,t.style.userSelect="none",t.addEventListener("click",(()=>sortByColumn(e))),a.appendChild(t)})),n.appendChild(a),t.appendChild(n);const o=document.createElement("tbody"),r=matches&&matches.length?matches.map((e=>sheetData[e])):sheetData,l=matches&&matches.length?matches.slice():sheetData.map(((e,t)=>t));r.forEach(((t,n)=>{const a=document.createElement("tr");a.dataset.rowIndex=l[n],e.forEach((e=>{const n=headers.indexOf(e),o=document.createElement("td"),r=n>-1&&null!=t[n]?String(t[n]):"";if(r.length>80){const e=document.createElement("span");e.textContent=r.slice(0,80)+"...";const t=document.createElement("span");t.textContent=r,t.style.display="none";const n=document.createElement("button");n.type="button",n.className="expand-btn",n.textContent="Expand",n.addEventListener("click",(a=>{a.stopPropagation(),"none"===t.style.display?(t.style.display="inline",e.style.display="none",n.textContent="Collapse"):(t.style.display="none",e.style.display="inline",n.textContent="Expand")})),o.appendChild(e),o.appendChild(t),o.appendChild(n)}else o.textContent=r;a.appendChild(o)})),o.appendChild(a)})),t.appendChild(o),tableViewContainer.appendChild(t),matches&&matches.length?(matchInfoDiv.style.display="block",matchInfoDiv.textContent=`Found ${matches.length} matches. Showing ${matchIndex+1} of ${matches.length}.`):matchInfoDiv.style.display="none"}function sortByColumn(e){const t=headers.indexOf(e);if(-1===t)return;const n=tableViewContainer.dataset.lastSort||"";let a="asc";n===e&&(a="asc"===tableViewContainer.dataset.lastDir?"desc":"asc"),tableViewContainer.dataset.lastSort=e,tableViewContainer.dataset.lastDir=a,sheetData.sort(((e,n)=>{const o=null!=e[t]?e[t]:"",r=null!=n[t]?n[t]:"",l=parseFloat(String(o).replace(/[^0-9.\-]/g,"")),s=parseFloat(String(r).replace(/[^0-9.\-]/g,""));if(!isNaN(l)&&!isNaN(s))return"asc"===a?l-s:s-l;const d=String(o).toLowerCase(),i=String(r).toLowerCase();return d<i?"asc"===a?-1:1:d>i?"asc"===a?1:-1:0})),renderTableView()}function navigateRelative(e){matches&&matches.length?(matchIndex=Math.max(0,Math.min(matches.length-1,matchIndex+(e>0?1:-1))),showRecord(matches[matchIndex]),updateMatchInfo(!0)):showRecord(currentIndex+e)}function updateNavButtons(){matches&&matches.length?(prevBtn.disabled=matchIndex<=0,nextBtn.disabled=matchIndex>=matches.length-1):(prevBtn.disabled=currentIndex<=0,nextBtn.disabled=currentIndex>=sheetData.length-1)}function goToRecord(){const e=parseInt(searchIndexInput.value,10);!isNaN(e)&&e>0&&e<=sheetData.length?showRecord(e-1):alert("Invalid row number.")}function filterRecords(){if(!sheetData||0===sheetData.length)return void alert("No data loaded.");const e=parseInt(filterColumnSelect.value,10),t=String(filterValueInput.value||""),n=t.trim().toLowerCase().replace(/\s+/g," ");n?(matches=[],sheetData.forEach(((t,a)=>{(t[e]??"").toString().toLowerCase().replace(/\s+/g," ").includes(n)&&matches.push(a)})),matches.length?(matchIndex=0,showRecord(matches[matchIndex]),filterInfoDiv.style.display="block",filterInfoDiv.textContent=`Filter: ${headers[e]} contains "${t}"`,updateMatchInfo(!0),syncUI()):alert("No matching records found.")):alert("Please enter a value to search.")}function updateMatchInfo(e=!1){matches&&0!==matches.length?(matchInfoDiv.style.display="block",matchInfoDiv.textContent=`Found ${matches.length} match(es). Showing ${matchIndex+1} of ${matches.length} (out of ${sheetData.length})`):matchInfoDiv.style.display="none"}function syncUI(){const e=sheetData&&sheetData.length>0;goBtn.disabled=!e,filterBtn.disabled=!e,searchIndexInput.disabled=!e,filterColumnSelect.disabled=!e,filterValueInput.disabled=!e,toggleTableBtn.style.display=e?"inline-block":"none",exportBtn.style.display=e?"inline-block":"none",updateNavButtons();try{document.body.focus()}catch(e){}}function showCurrentView(){"table"===viewMode?(updateViewButtons(),renderTableView()):(updateViewButtons(),showRecord(currentIndex))}function updateViewButtons(){"table"===viewMode?(toggleTableBtn.textContent="Form View",tableViewContainer.style.display="block",recordViewer.style.display="none",prevBtn.disabled=!0,nextBtn.disabled=!0):(toggleTableBtn.textContent="Table View",tableViewContainer.style.display="none",recordViewer.style.removeProperty("display"),prevBtn.disabled=!1,nextBtn.disabled=!1)}function showExportMenu(){exportVisibleXLSX()}function getDisplayedRowsAndHeaders(){const e=visibleHeaders&&visibleHeaders.length?visibleHeaders:headers,t=matches&&matches.length?matches.slice():sheetData.map(((e,t)=>t)),n=t.map((e=>sheetData[e].map((e=>null!=e?String(e):""))));return{cols:e,rowIndexes:t,rows:n}}function exportVisibleCSV(){const{cols:e,rowIndexes:t}=getDisplayedRowsAndHeaders(),n=[];n.push(e.map((e=>`"${e.replace(/"/g,'""')}"`)).join(",")),t.forEach((t=>{const a=sheetData[t],o=e.map((e=>{const t=headers.indexOf(e);return`"${(t>-1&&null!=a[t]?String(a[t]):"").replace(/"/g,'""')}"`}));n.push(o.join(","))}));const a=n.join("\r\n"),o=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(o),l=document.createElement("a");l.href=r,l.download="export.csv",document.body.appendChild(l),l.click(),l.remove(),URL.revokeObjectURL(r)}function exportVisibleXLSX(){const{cols:e,rowIndexes:t}=getDisplayedRowsAndHeaders(),n=[];n.push(e),t.forEach((t=>{const a=sheetData[t],o=e.map((e=>{const t=headers.indexOf(e);return t>-1&&null!=a[t]?a[t]:""}));n.push(o)}));const a=XLSX.utils.aoa_to_sheet(n),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,a,"Export");const r=XLSX.write(o,{bookType:"xlsx",type:"array"}),l=new Blob([r],{type:"application/octet-stream"}),s=URL.createObjectURL(l),d=document.createElement("a");d.href=s,d.download="export.xlsx",document.body.appendChild(d),d.click(),d.remove(),URL.revokeObjectURL(s)}function init(){updateViewButtons(),syncUI()}window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),deferredPrompt=e,installBtn.style.display="inline-block"})),installBtn.addEventListener("click",(async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();"accepted"===(await deferredPrompt.userChoice).outcome&&(installBtn.textContent="✅ Installed",installBtn.disabled=!0),deferredPrompt=null})),window.addEventListener("appinstalled",(()=>{installBtn.textContent="✅ Installed",installBtn.disabled=!0})),document.addEventListener("keydown",(e=>{const t=e.target&&e.target.tagName&&e.target.tagName.toUpperCase();sheetData&&0!==sheetData.length&&("INPUT"===t||"TEXTAREA"===t||"SELECT"===t||e.ctrlKey||e.metaKey||("ArrowRight"===e.key&&(e.preventDefault(),matches&&matches.length?matchIndex<matches.length-1&&(matchIndex++,showRecord(matches[matchIndex]),updateMatchInfo(!0)):currentIndex<sheetData.length-1&&showRecord(currentIndex+1)),"ArrowLeft"===e.key&&(e.preventDefault(),matches&&matches.length?matchIndex>0&&(matchIndex--,showRecord(matches[matchIndex]),updateMatchInfo(!0)):currentIndex>0&&showRecord(currentIndex-1))))})),recordViewer.addEventListener("click",(e=>{if(e.target.classList.contains("expand-btn")){const t=e.target.closest(".field"),n=t.querySelector(".field-value"),a=t.querySelector(".full-text").textContent;"Expand"===e.target.textContent?(n.textContent=a,e.target.textContent="Collapse"):(n.textContent=a.slice(0,60)+"...",e.target.textContent="Expand")}})),tableViewContainer.addEventListener("click",(e=>{const t=e.target.closest("tr[data-row-index]");if(!t)return;const n=parseInt(t.dataset.rowIndex,10);isNaN(n)||(viewMode="form",localStorage.setItem("viewMode",viewMode),updateViewButtons(),showRecord(n))})),init();
